import logging
import json
from datetime import datetime
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import JsonOutputParser
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate
from langchain_core.pydantic_v1 import BaseModel, Field
from typing import Any, Dict
from typing import List
import pytz
from flask import request, jsonify
import os

# json 파서를 설정하고 프롬프트 템플릿에 지시사항을 주입
class hotelInfo(BaseModel):
    intro: str = Field(..., description="호텔에 대한 소개글 작성")
    rooms: str = Field(..., description="호텔 객실타입별 특징에 대한 내용 작성")
    facilities: str = Field(..., description="호텔 부대시설과 관련한 내용 작성")
    dining: str = Field(..., description="호텔 다이닝/레스토랑에 대한 내용 작성")
    location: str = Field(..., description="호텔 위치/호텔 주변정보에 대한 내용")

def main(request):
    try:
        # Request JSON 파싱
        data = request.get_json(silent=True)
        content = data['calls'][0][0]

        #특이 문자 제거 
        content = content.replace("\\n", "").replace("\\u", "").replace("\\\\", "").replace("\\", "")     

        os.environ['OPENAI_API_KEY'] = "openai api key 입력하는곳"

        # LLM 객체 생성
        model = ChatOpenAI(
            temperature=0.3,
            model_name="gpt-4o"
        )

        # Prompt 템플릿 JSON 버전 
        # template = """
        # 당신은 럭셔리 호텔 전문 에디터로, 매력적인 호텔 Article을 작성해야 합니다.
        # 럭셔리하고 세련된 톤으로 작성해주세요. 감각적인 형용사를 사용하되, 과장되지 않도록 주의해주세요.
        # Article의 형식은 제시된 [EXAMPLE]을 참고하되, [호텔정보]에 있는 내용으로만 구성하세요.
        # 한글로 최대한 자연스럽게 작성해주세요.

        # [호텔정보]:
        # {content}

        # [EXAMPLE]:
        # {{
        # "intro": "헤렌그라흐트 운하를 마주한 월도프 아스토리아 암스테르담. 17세기 궁전의 고전미와 현대적인 시설이 완벽하게 어우러진 5성급 호텔이다. 호텔의 93개 객실은 유럽 역사로부터 영감을 받아 설계되었으며 각각 운하와 정원의 매혹적인 전망을 선사한다. 또한 2개의 미슐랭 스타 레스토랑과 베네룩스 유일의 겔랑 SPA, 실내 수영장과 피트니스 센터 등 럭셔리 호텔의 필수 요소를 모두 갖추고 있다. 렘브란트 광장, 국립 해양 박물관 등 근처 명소와 접근성 또한 뛰어나 여행과 휴식을 동시에 만족시키는 이곳. 월도프 아스토리아 암스테르담을 소개한다.",
        # "rooms":  [{{"슈페리어 룸 / Superior Room":"호텔의 가장 기본 객실로 최대 2인이 묵을 수 있으며 28~34㎡의 규모로 이루어져 있다. 객실에는 월도프 아스토리아 시그니처 킹 베드 1개와 무료 WiFi, 사무용 책상 등이 제공된다. 또한 샤워부스가 있는 대리석 욕실을 갖추고 있으며 전 객실 어메니티는 이솝 브랜드의 제품이 비치돼 있다."}}, {{"프리미어 발코니 / Premier balcony":"호텔 최상층에 위치한 프리미어 발코니 객실은 최대 2인이 묵을 수 있는 객실이다. 킹사이즈 베드 1개가 제공되며 샤워부스와 별도의 욕조가 설치된 욕실이 마련돼 있다. 도심의 탁 트인 전망과 함께 평화로운 시간을 경험해 보자."}}, {{"로프트 / Lofts":"로프트 객실은 호텔 최상층에 위치해 독특한 설계를 자랑한다. 전통 목재 기둥으로 편안하고 따뜻한 분위기를 연출했으며 고급 가구와 소품으로 우아함을 더했다. 객실 규모는 49㎡로 킹사이즈 베드와 업무용 책상, 미니바 등이 제공된다. 욕조에는 샤워부스와 분리된 욕조, TV가 설치돼 있어 한층 깊은 휴식을 누릴 수 있다."}}, ...],       
        # "facilities": [{{"겔랑 스파 / Guerlain Spa":"세계적인 코스메틱 브랜드 '겔랑'의 스파 시설을 호텔 내 부대시설로 갖추고 있다. 사우나와 스팀룸, 트리트먼트룸 등으로 이루어져 있으며 페이셜 마사지부터 전신 마사지, 메이크업 서비스도 제공한다. 운영 시간: 9:00am~9:00pm"}},{{"실내 수영장 / swimming pool":"실내 수영장은 겔랑 스파 안쪽에 위치해 있다. 투숙객을 위한 전용 공간으로 자정까지 운영돼 비교적 자유롭게 이용 가능하다."}},{{" 피트니스 센터 / Gym":"여행 중에도 운동 루틴을 놓치고 싶지 않다면 피트니스 센터를 놓치지 말자. 투숙객 전용 공간으로 24시간 동안 운영돼 언제든 이용 가능하다. 또한 호텔의 프라이빗 가든을 바라보고 있어 더욱 상쾌하게 운동을 즐길 수 있다. 운영 시간: 24시간"}}...]],
        # "dining": [{{"스펙트럼 / Spectrum": "월도프 아스토리아 암스테르담의 메인 레스토랑으로 셰프 시드니 슈트가 이끄는 미슐랭 2스타 레스토랑이다. 신선한 현지 식재료를 활용한 고급 7코스부터 비건을 위한 식사까지 다양한 메뉴가 준비된다. 운영 시간: 수~일 6:00pm~10:00pm"}},{{"피콕 앨리 / Peacock Alley":"고급스러운 분위기가 돋보이는 월도프 아스토리아 암스테르담의 라운지다. 이곳에서는 여유로운 점심 식사를 즐겨도 좋고 애프터눈 티와 저녁 식사, 수제 칵테일을 맛봐도 좋다. 운영 시간: 10:00am~10:00pm (애프터눈 티 수~일 3:00pm~5:00pm)"}},...],
        # "location": "월도프 아스토리아 암스테르담은 암스테르담 중심부에 위치해 있다. 중앙역에서 차로 10분, 공항에서 차로 15분 거리로 접근성이 매우 뛰어나다. 좀 더 편안하게 이동하고 싶다면 셔틀 및 공항 픽업 서비스를 요청해보자. 호텔은 인근에 운하 지구, 렘브란트 광장, 반 고흐 미술관 등 주요 명소가 있어 여행과 휴식을 동시에 누릴 수 있다."
        # }}

        # """

        # Prompt 템플릿 텍스트 버전 (샘플로 실제 문장)
        # template = """
        # 당신은 럭셔리 호텔 전문 에디터로, 매력적인 호텔 Article을 작성해야 합니다.
        # 럭셔리하고 세련된 톤으로 작성해주세요. 감각적인 형용사를 사용하되, 과장되지 않도록 주의해주세요.
        # [호텔정보]에 있는 내용을 바탕으로 작성해주세요.
        # 문체와 글의 구조는 제시된 [EXAMPLE]을 참고하세요. 
        # 한글로 최대한 자연스럽게 작성해주세요.

        # [호텔정보]:
        # {content}

        # [EXAMPLE]
        
        # - 호텔 소개 

        # 헤렌그라흐트 운하를 마주한 월도프 아스토리아 암스테르담. 17세기 궁전의 고전미와 현대적인 시설이 완벽하게 어우러진 5성급 호텔이다. 호텔의 93개 객실은 유럽 역사로부터 영감을 받아 설계되었으며 각각 운하와 정원의 매혹적인 전망을 선사한다. 또한 2개의 미슐랭 스타 레스토랑과 베네룩스 유일의 겔랑 SPA, 실내 수영장과 피트니스 센터 등 럭셔리 호텔의 필수 요소를 모두 갖추고 있다. 렘브란트 광장, 국립 해양 박물관 등 근처 명소와 접근성 또한 뛰어나 여행과 휴식을 동시에 만족시키는 이곳. 월도프 아스토리아 암스테르담을 소개한다.

        # - 객실 ROOMS & SUITES 

        # 1. 슈페리어 룸 / Superior Room: 객실에는 월도프 아스토리아 시그니처 킹 베드 1개와 무료 WiFi, 사무용 책상 등이 제공된다. 또한 샤워부스가 있는 대리석 욕실을 갖추고 있으며 전 객실 어메니티는 이솝 브랜드의 제품이 비치돼 있다.  
        # 2. 프리미어 발코니 / Premier balcony: 호텔 최상층에 위치한 프리미어 발코니 객실은 최대 2인이 묵을 수 있는 객실이다. 킹사이즈 베드 1개가 제공되며 샤워부스와 별도의 욕조가 설치된 욕실이 마련돼 있다. 도심의 탁 트인 전망과 함께 평화로운 시간을 경험해 보자.
        # 3. 로프트 / Lofts: 로프트 객실은 호텔 최상층에 위치해 독특한 설계를 자랑한다. 전통 목재 기둥으로 편안하고 따뜻한 분위기를 연출했으며 고급 가구와 소품으로 우아함을 더했다. 객실 규모는 49㎡로 킹사이즈 베드와 업무용 책상, 미니바 등이 제공된다. 욕조에는 샤워부스와 분리된 욕조, TV가 설치돼 있어 한층 깊은 휴식을 누릴 수 있다.

        # - 편의시설 FACILITIES 

        # 1. 겔랑 스파 / Guerlain Spa: 세계적인 코스메틱 브랜드 '겔랑'의 스파 시설을 호텔 내 부대시설로 갖추고 있다. 사우나와 스팀룸, 트리트먼트룸 등으로 이루어져 있으며 페이셜 마사지부터 전신 마사지, 메이크업 서비스도 제공한다. 운영 시간은 9:00am~9:00pm. 
        # 2. 실내 수영장 / swimming pool: 실내 수영장은 겔랑 스파 안쪽에 위치해 있다. 투숙객을 위한 전용 공간으로 자정까지 운영돼 비교적 자유롭게 이용 가능하다. 
        # 3. 피트니스 센터 / Gym: 여행 중에도 운동 루틴을 놓치고 싶지 않다면 피트니스 센터를 놓치지 말자. 투숙객 전용 공간으로 24시간 동안 운영돼 언제든 이용 가능하다. 또한 호텔의 프라이빗 가든을 바라보고 있어 더욱 상쾌하게 운동을 즐길 수 있다. 운영 시간은 24시간 
        # ...

        # - 레스토랑 & 바 RESTAURANT & BAR 

        # 1. 스펙트럼 / Spectrum: 월도프 아스토리아 암스테르담의 메인 레스토랑으로 셰프 시드니 슈트가 이끄는 미슐랭 2스타 레스토랑이다. 신선한 현지 식재료를 활용한 고급 7코스부터 비건을 위한 식사까지 다양한 메뉴가 준비된다. 운영 시간은 수~일 6:00pm~10:00pm. 
        # 2. 피콕 앨리 / Peacock Alley: 고급스러운 분위기가 돋보이는 월도프 아스토리아 암스테르담의 라운지다. 이곳에서는 여유로운 점심 식사를 즐겨도 좋고 애프터눈 티와 저녁 식사, 수제 칵테일을 맛봐도 좋다. 운영 시간은 10:00am~10:00pm (애프터눈 티 수~일 3:00pm~5:00pm) 
        # ... 

        # - 위치 및 주변 정보 LOCATION & LOCAL INFORMATION 
        # 월도프 아스토리아 암스테르담은 암스테르담 중심부에 위치해 있다. 중앙역에서 차로 10분, 공항에서 차로 15분 거리로 접근성이 매우 뛰어나다. 좀 더 편안하게 이동하고 싶다면 셔틀 및 공항 픽업 서비스를 요청해보자. 호텔은 인근에 운하 지구, 렘브란트 광장, 반 고흐 미술관 등 주요 명소가 있어 여행과 휴식을 동시에 누릴 수 있다.

        # """

        # Prompt 템플릿 텍스트 버전 (샘플에 실제 데이터 X)
        template = """
        호텔을 소개하는 글을 아래의 호텔정보를 이용해서 작성하세요. 
        제공된 호텔정보를 최대한 활용해서 작성하고, 작성할 수 없는 항목이 있다면 "N/A"값을 반환하세요. 
        출력구조는 [EXAMPLE]을 참고하세요. 
        한글로 최대한 자연스럽게 작성해주세요.

        [호텔정보]:
        {content}

        [EXAMPLE]
        
        - 호텔 소개 

        여기에 호텔에 대한 특징과 매력적인 정보를 요약해서 입력하세요. 

        - 객실 ROOMS & SUITES 
        여기에 객실 타입과 각 타입 별 특징들을 bullet형태로 나열하세요.

        - 편의시설 FACILITIES 
        여기에 편의시설과 각 편의시설 별 정보와 운영시간을 bullet형태로 나열하세요. 

        - 레스토랑 & 바 RESTAURANT & BAR 
        여기에 레스토랑과 바에 대한 정보와 운영시간을 bullet형태로 나열하세요. 

        - 위치 및 주변 정보 LOCATION & LOCAL INFORMATION 
        여기에 주변시설과 위치, 접근성을 알 수 있는 정보를 요약해서 입력하세요. 

        """

        #prompt template 버전 
        # key값은 무조건 영어로 json형태 다시 설계. section, title, descrtiion
        # input을 json형태로 주는것도 고려. 


        # output_parser = JsonOutputParser(pydantic_object=hotelInfo)
        output_parser = StrOutputParser()
        prompt = PromptTemplate.from_template(template)

        # 체인 구성
        chain = prompt | model | output_parser

        # .invoke() 메서드를 사용하여 실행
        result = chain.invoke({"content": content})

    except Exception as e:
        result = {"error":f"{e}"}

    return json.dumps( { "replies" :  [result] },ensure_ascii = False  )     
